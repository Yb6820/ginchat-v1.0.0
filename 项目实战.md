---
typora-copy-images-to: Typoraimgs
typora-root-url: Typoraimgs
---

# Gin+Websocket项目实战IM

## 介绍

Gin是目前golang使用最广泛的Web架构之一

Web开发框架，适合api接口，微服务开发，相较于其他框架(iris,beggo)更轻量级和更好的性能。其路由功能很强大提供分组功能。非常适合做api开发

API：https://gin-gonic.com/zh-cn/docs/

## 需求分析：

### 项目目的：

项目背景：IM对性能和体验敏感度非常高。



### 将获得什么

熟悉开发流程，熟悉下官技术栈gin+GORM+swagger+logrus auth等中间件

### 核心功能：

发送和接收消息，文章 表情 图片 音频，方可，点对点，群聊，广播，快捷回复，撤回，心跳检测



### 技术栈

​	前端  后端（webSocket,channel/goroutine,gin,template,gorm,sql,nosql,mq...） 



### 系统架构

四层：前端，接入层，逻辑层，持久层



### 消息发送流程：

A->登录>鉴权>(游客)>消息类型>(群聊/广播)>B

（需求文档   表设计  功能设计文档）



## 环境搭建：

### 1、GORM的引入

需要的包可以在 [Go Packages](https://pkg.go.dev/) 找

引入gorm：go get -u gorm.io/gorm

引入mysql数据库驱动：go get -u gorm.io/driver/mysql



#### 用户模块struct 设计

创建models包userBasic.go再写一个struct

```go
package models

import (
	"time"

	"gorm.io/gorm"
)

type UserBasic struct {
	gorm.Model
	Name          string
	PassWord      string
	Phone         string
	Email         string
	Identity      string
	ClientIp      string
	ClientPort    string
	LoginTime     time.Time
	HeartbeatTime time.Time
	LogOutTime    time.Time
	IsLogout      bool
	DeviceInfo    string
}

func (table *UserBasic) TableName() string {
	return "user_basic"
}
```



测试数据正确性。

让后端 封装 配置类 测试类

创建test包 testGorm.go

```go
package main

import (
	"fmt"
	"ginchat/models"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

func main() {
	db, err := gorm.Open(mysql.Open("root:181234@tcp(192.168.17.95:3306)/ginchat?charset=utf8mb4&parseTime=True&loc=Local"), &gorm.Config{})
	if err != nil {
		panic("failed to connect database")
	}

	// Migrate the schema
	//创建表，没有则新创
	db.AutoMigrate(&models.UserBasic{})

	// Create
	user := &models.UserBasic{}
	user.Name = "张三"
	db.Create(user)

	// 读取数据
	fmt.Println(db.First(user, 1)) // find product with integer primary key
	//db.First(user, "code = ?", "D42") // find product with code D42

	// Update - update product's price to 200
	db.Model(user).Update("PassWord", 1234)
	// Update - update multiple fields
	//db.Model(&product).Updates(Product{Price: 200, Code: "F42"}) // non-zero fields
	//db.Model(&product).Updates(map[string]interface{}{"Price": 200, "Code": "F42"})

	// Delete - delete product
	//db.Delete(&product, 1)
}
```

运行查看数据情况



### 2、引入Gin框架

```go
go get -u github.com/gin-gonic/gin
```



```go
//项目跟目录下
package main

//项目入口
import (
	"ginchat/router"
)

func main() {
	r := router.Router()
	r.Run() // 监听并在 0.0.0.0:8080 上启动服务
}


//router包app.go
package router

import (
	"ginchat/service"

	"github.com/gin-gonic/gin"
)

func Router() *gin.Engine {
	r := gin.Default()
	r.GET("/index", service.GetIndex)
	return r
}


//service包index.go
package service

import "github.com/gin-gonic/gin"

func GetIndex(c *gin.Context) {
	c.JSON(200, gin.H{
		"message": "welcome",
	})
}
```





### 3、将数据和请求关联起来

1. 在main方法里面初始化配置文件以及数据库

   utils.InitConfig()

   utils.InitMySQL

2. 在config包里面app.yaml

   ```yaml
   mysql:
     dns: root:181234@tcp(192.168.17.95:3306)/ginchat?charset=utf8mb4&parseTime=True&loc=Local
   ```

3. 新建utils包 system_Init.go

   ```go
   package utils
   
   import (
   	"fmt"
   
   	"github.com/spf13/viper"
   	"gorm.io/driver/mysql"
   	"gorm.io/gorm"
   )
   
   var DB *gorm.DB
   
   func InitConfig() {
   	viper.SetConfigName("app")
   	viper.AddConfigPath("config")
   	err := viper.ReadInConfig()
   	if err != nil {
   		fmt.Println(err)
   	}
       fmt.Println("config app inited")
   	fmt.Println("config mysql inited...")
   }
   
   func InitMySQL() {
   	DB, _ = gorm.Open(mysql.Open(viper.GetString("mysql.dns")), &gorm.Config{})
   }
   ```

4. 到userBasic.go里面加上

   ```go
   func GetUserList() []*UserBasic {
   	data := make([]*UserBasic, 10)
   	utils.DB.Find(&data)
   	for _, v := range data {
   		fmt.Println(v)
   	}
   	return data
   }
   ```

5. 到service包里面新建userservice.go

   ```go
   package service
   
   import (
   	"ginchat/models"
   
   	"github.com/gin-gonic/gin"
   )
   
   func GetUserList(c *gin.Context) {
   	data := make([]*models.UserBasic, 10)
   	data = models.GetUserList()
   	c.JSON(200, gin.H{
   		"message": data,
   	})
   }
   ```

6. 将页面写到router包的app.go里面

   ```go
   r.GET("user/getUserList", service.GetUserList)
   ```





### 4、整合swaggo

```go
go get -u github.com/swaggo/swag/cmd/swag
go install github.com/swaggo/swag/cmd/swag  //go install后会在GOPATH/bin目录下生成swag.exe  我的GOPATH在C:\Users\夙愿\go\bin   需要将该路径加到系统PATH里，不然后面的init swag会报错
swag init //会在根目录下生成docs目录
//拉取gin-swaggo的包
go get -u github.com/swaggo/gin-swagger
go get -u github.com/swaggo/files

//还早我们的router包的app.go
package router

import (
	"ginchat/docs"
	"ginchat/service"

	"github.com/gin-gonic/gin"
	swaggerfiles "github.com/swaggo/files"
	ginSwagger "github.com/swaggo/gin-swagger"
)

func Router() *gin.Engine {
	r := gin.Default()
	docs.SwaggerInfo.BasePath = ""
	r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerfiles.Handler))

	r.GET("/index", service.GetIndex)
	r.GET("/user/getUserList", service.GetUserList)

	return r
}

//添加swagggo的注解后swag init一下 中间不要有空行
//然后测试index页面是否正常
package service

import "github.com/gin-gonic/gin"

// GetIndex
// @Tags 首页
// @Success 200 {string} welcome
// @Router /index [get]
func GetIndex(c *gin.Context) {
	c.JSON(200, gin.H{
		"message": "welcome",
	})
}

//以及userservice.go的内容
package service

import (
	"ginchat/models"

	"github.com/gin-gonic/gin"
)

// GetUserList
// @Tags 首页
// @Success 200 {string} json{"code","message"}
// @Router /user/getUserList [get]
func GetUserList(c *gin.Context) {
	data := make([]*models.UserBasic, 10)
	data = models.GetUserList()
	c.JSON(200, gin.H{
		"message": data,
	})
}
```

![1673414143190](/1673414143190.png)





### 5、打印日志

在数据库初始化的时候加入自己的logger

```go
func InitMySQL() {
	//配置日志
	newLogger := logger.New(
		log.New(os.Stdout, "\r\n", log.LstdFlags), //write参数
		logger.Config{
			SlowThreshold: time.Second, //慢SQL阈值
			LogLevel:      logger.Info, //级别
			Colorful:      true,        //彩色
		})

	DB, _ = gorm.Open(mysql.Open(viper.GetString("mysql.dns")), &gorm.Config{Logger: newLogger})
}
```

## 功能实现

### 1、完成用户模块基本功能

**加入修改电话号码和邮箱并校验**

先引入

```go
go get github.com/asaskevich/govalidator
//结构以字段后面家校验规则
//最后service govalidator.ValidatorStruct(user)条用校验
```



1. router包app.go

   ```go
   r.GET("/user/getUserList", service.GetUserList)
   	r.GET("/user/createUser", service.CreateUser)
   	r.GET("/user/deleteUser", service.DeleteUser)
   	r.POST("/user/updateUser", service.UpdateUser)
   ```

2. service包userservice.go

   ```go
   // CreateUser
   // @Summary 新增用户
   // @Tags 用户模块
   // @param name query string false "用户名"
   // @param password query string false "密码"
   // @param repassword query string false "确认密码"
   // @Success 200 {string} json{"code","message"}
   // @Router /user/createUser [get]
   func CreateUser(c *gin.Context) {
   	user := models.UserBasic{}
   	user.Name = c.Query("name")
   	password := c.Query("password")
   	repassword := c.Query("repassword")
   	if password != repassword {
   		c.JSON(-1, gin.H{
   			"message": "两次密码不一致",
   		})
   		return
   	}
   	user.PassWord = password
   	models.CreateUser(user)
   	c.JSON(200, gin.H{
   		"message": "新增用户成功!",
   	})
   }
   
   // DeleteUser
   // @Summary 删除用户
   // @Tags 用户模块
   // @param id query string false "id"
   // @Success 200 {string} json{"code","message"}
   // @Router /user/deleteUser [get]
   func DeleteUser(c *gin.Context) {
   	user := models.UserBasic{}
   	id, _ := strconv.Atoi(c.Query("id"))
   	user.ID = uint(id)
   	models.DeleteUser(user)
   	c.JSON(200, gin.H{
   		"message": "删除用户成功!",
   	})
   }
   
   // UpdateUser
   // @Summary 更新用户
   // @Tags 用户模块
   // @param id formData string false "id"
   // @param name formData string false "name"
   // @param password formData string false "password"
   // @param phone formData string false "phone"
   // @param email formData string false "email"
   // @Success 200 {string} json{"code","message"}
   // @Router /user/updateUser [post]
   func UpdateUser(c *gin.Context) {
   	user := models.UserBasic{}
   	id, _ := strconv.Atoi(c.PostForm("id"))
   	user.ID = uint(id)
   	user.Name = c.PostForm("name")
   	user.PassWord = c.PostForm("password")
   	user.Phone = c.PostForm("phone")
   	user.Email = c.PostForm("email")
   
   	_, err := govalidator.ValidateStruct(user)
   	if err != nil {
   		fmt.Println(err)
   		c.JSON(200, gin.H{
   			"message": "修改参数不匹配!",
   		})
   	} else {
   		models.UpdateUser(user)
   		c.JSON(200, gin.H{
   			"message": "修改用户成功!",
   		})
   	}
   }
   ```

3. models包userBasic.go

   ```go
   Phone         string `valid:"matches(^1[3-9]{1}\\d{9}$)"`
   Email         string `valid:"email"`
   ```

4. 然后测试

   ![1673420397727](/1673420397727.png)





### 2、重复注册校验

```go
// 名字唯一确定一个人
func FindUserByNameAndPwd(name string, password string) UserBasic {
	user := UserBasic{}
	utils.DB.Where("name = ? and pass_word = ?", name, password).First(&user)
	return user
}
// 名字唯一确定一个人
func FindUserByName(name string) UserBasic {
	user := UserBasic{}
	utils.DB.Where("name = ?", name).First(&user)
	return user
}
// 电话号码只能注册一个账号
func FindUserByPhone(phone string) UserBasic {
	user := UserBasic{}
	utils.DB.Where("phone = ?", phone).First(&user)
	return user
}

//再到service包 加入判断
data := models.FindUserByName(user.Name)
	if data.Name != "" {
		c.JSON(-1, gin.H{
			"message": "用户名已注册",
		})
		return
	}
```



### 3、注册加密操作

```go
package utils

import (
	"crypto/md5"
	"encoding/hex"
	"strings"
)
// 小写  哈希加密
func Md5Encode(data string) string {
	h := md5.New()
	h.Write([]byte(data))
	tempStr := h.Sum(nil)
	return hex.EncodeToString(tempStr)
}
// 转大写
func MDEEncode(data string) string {
	return strings.ToUpper(Md5Encode(data))
}
// 加密
func MakePassword(plainpwd, salt string) string {
	return Md5Encode(plainpwd + salt)
}
// 解密
func ValidPassword(plainpwd, salt string, password string) bool {
	return Md5Encode(plainpwd+salt) == password
}

//service层 判断之后加入
//利用随机数加密
	user.PassWord = utils.MakePassword(password, salt)
	user.Salt = salt
	models.CreateUser(user)
	c.JSON(200, gin.H{
		"message": "新增用户成功!",
	})
```

### 4、登录解密

```go
//user_basic包下
// 登录校验
func FindUserByNameAndPwd(name string, password string) UserBasic {
	user := UserBasic{}
	utils.DB.Where("name = ? and pass_word = ?", name, password).First(&user)
	return user
}

//userservice包下
// FindUserByNameAndPwd
// @Summary 用户登录
// @Tags 用户模块
// @param name query string false "用户名"
// @param password query string false "密码"
// @Success 200 {string} json{"code","message"}
// @Router /user/findUserByNameAndPwd [post]
func FindUserByNameAndPwd(c *gin.Context) {
	name := c.Query("name")
	password := c.Query("password")
	user := models.FindUserByName(name)
	if user.Name == "" {
		c.JSON(200, gin.H{
			"message": "该用户不存在",
		})
		return
	}
	flag := utils.ValidPassword(password, user.Salt, user.PassWord)
	if !flag {
		c.JSON(200, gin.H{
			"message": "密码不正确",
		})
		return
	}
	//校验密码
	pwd := utils.MakePassword(password, user.Salt)
	data := models.FindUserByNameAndPwd(name, pwd)

	c.JSON(200, gin.H{
		"message": data,
	})
}


//再router包加入地址
r.POST("/user/findUserByNameAndPwd", service.FindUserByNameAndPwd)
```





### 5、token的加入和对返回结构的调整

修改登陆的方法

```go
// 登录校验
func FindUserByNameAndPwd(name string, password string) UserBasic {
	user := UserBasic{}
	utils.DB.Where("name = ? and pass_word = ?", name, password).First(&user)
	//token加密
	str := fmt.Sprintf("%d", time.Now().Unix())
	temp := utils.MD5Encode(str)
	utils.DB.Model(&user).Where("id = ?", user.ID).Update("Identity", temp)
	return user
}


//返回的结果按下面的格式来
c.JSON(200, gin.H{
		"code":    0, //0成功     -1失败
		"message": "删除用户成功！",
		"data":    user,
	})
```





### 6、加入Redis

#### 配置虚拟机的Redis环境

参考博客： [(164条消息) 【centos安装redis】（超详细）_AlanDreamer的博客-CSDN博客](https://blog.csdn.net/qq_39187538/article/details/126485922) 

##### 1、下载和安装redis

```bash
//先在根目录下创建/tools/installbags的目录
cd /
mkdir tools
cd /tools
mkdir installbags
cd /tools/installbags
//下载redis压缩包
wget https://download.redis.io/releases/redis-7.0.2.tar.gz
//解压
tar -zxf redis-7.0.2.tar.gz -C /tools/installbags
//编译
make 
//安装在/tools/redis目录下
make install PREFIX=/tools/redis
```

安装完成

![在这里插入图片描述](https://img-blog.csdnimg.cn/fa66eeb8331a420aaaf6069af342760c.png) 

设置环境变量和生效环境变量

```bash
vim ~/.bash_profile
//在文件末尾加入以下内容
REDIS_HOME=/tools/redis
PATH=$PATH:$REDIS_HOME/bin
//生效配置
source ~/.bash_profile
```

##### 2、启动和停止redis

```bas
#实际是去找/tools/redis/bin的这个启动语句,并使用redis配置文件
redis-server /tools/installbags/redis-7.0.2/redis.conf
#/tools/redis/bin的这个预计进行停止
redis-cli shutdown
```

##### 3、测试redis服务

```bash
redis-cli  #启动redis服务的命令
set name potato	#设置name变量
name  #查看name变量
```

##### 4、redis.conf文件的配置(redis.conf在解压后的redis文件里面)

**下述配置需手动查找：**

```bash
#设置后台启动，如果不是后台启动，每次推出redis就关闭了
daemonize yes
#开启密码保护，注释则不需要密码
requirepass 密码
#设置端口号
port 端口号
#允许访问的ip，改为0.0.0.0就是所有ip均可
bind 127.0.0.1 -::1
bind 0.0.0.0
```

**先用cat -n redis.conf |grep 'daemonize' 查找出大致的位置再去做修改。**

![1673538591715](/1673538591715.png)

默认是没有密码的按需要加入

![1673538760700](/1673538760700.png)

![1673538840215](/1673538840215.png)

![1673538878095](/1673538878095.png)

##### 5、设置开机自动启动

**在/usr/lib/systemd/system目录下配置文件redis.service**

```bash
cd /usr/lib/systemd/system
touch redis.service
vim redis.service
# 在redis.service文件里加入一下内容

[Unit]
Description=redis-server
After=network.target

[Service]
Type=forking

ExecStart=/tools/redis/bin/redis-server /tools/installbags/redis-7.0.2/redis.conf
# 下面这一条是用来配置密码的，前面设了密码就要配置这一条
ExecStop=/tools/installbags/redis-7.0.2/src/redis-cli -a "181234" shutdown
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

**启动服务的一些命令**

```bash
#重载系统服务
systemctl daemon-reload
#设置开机自启
systemctl enable redis.service
#取消开机自启
systemctl disabled redis.service
#启动服务
systemctl start redis.service
#停止服务
systemctl stop redis.service
#查看服务状态
systemctl status redis.service
```

配置好服务后应该出现一下页面

![1673539278177](/1673539278177.png)





#### Go项目引入Redis

使用的是redis7，带入下列包

```go
go get github.com/go-redis/redis/v9
```

配置app.xml里面的redis

```yaml
redis:
  addr: "192.168.17.95:6379"
  password: "181234"
  DB: 0
  poolSize: 30
  minIdleConn: 30
```

然后在main方法中加入

utils.InitRedis()

最后在utils.go中加入

```go
func InitRedis() {
	Red = redis.NewClient(&redis.Options{
		Addr:         viper.GetString("redis.addr"),
		Password:     viper.GetString("redis.password"),
		DB:           viper.GetInt("redis.DB"),
		PoolSize:     viper.GetInt("redis.poolSize"),
		MinIdleConns: viper.GetInt("redis.minIdleConn"),
	})
	ctx, cancel := context.WithCancel(context.Background())

	pong, err := Red.Ping(ctx).Result()

	if err != nil {
		fmt.Println("init redis ....", err)
	} else {
		fmt.Println("Redis inited ....", pong)
	}
	cancel()
}
```





### 7、通过Websocket通信

```go
//先获取所需的包
go get github.com/gorilla/websocket

//utils包中加入
const (
	PublicKey = "websocket"
)

// Publish 发布消息到Redis
func Publish(ctx context.Context, channel string, msg string) error {
	err := Red.Publish(ctx, channel, msg).Err()
	fmt.Println("Publish ....", msg)
	if err != nil {
		fmt.Println(err)
	}
	return err
}

// Subscribe 订阅Redis消息
func Subscribe(ctx context.Context, channel string) (string, error) {
	sub := Red.Subscribe(ctx, channel)
	msg, err := sub.ReceiveMessage(ctx)
	if err != nil {
		fmt.Println(err)
		if err != nil {
			fmt.Println(err)
		}
	}
	fmt.Println("Subscribe......", msg.Payload)
	return msg.Payload, err
}


//userservice中加入
// 防止跨域站点的伪造请求
var upGrade = websocket.Upgrader{
	CheckOrigin: func(r *http.Request) bool {
		return true
	},
}

func SendMsg(c *gin.Context) {
	ws, err := upGrade.Upgrade(c.Writer, c.Request, nil)
	if err != nil {
		fmt.Println(err)
		return
	}
	defer func(ws *websocket.Conn) {
		err = ws.Close()
		if err != nil {
			fmt.Println(err)
		}
	}(ws)
	MsgHandler(ws, c)
}
func MsgHandler(ws *websocket.Conn, c *gin.Context) {
	for {
		msg, err := utils.Subscribe(c, utils.PublicKey)
		if err != nil {
			fmt.Println(err)
			return
		}
		fmt.Println("发送消息", msg)
		tm := time.Now().Format("2006-01-02 15:04:05")
		m := fmt.Sprintf("[ws][%s]:%s", tm, msg)
		err = ws.WriteMessage(1, []byte(m))
		if err != nil {
			fmt.Println(err)
		}
	}
}


//router中加入
r.GET("/user/sendMsg", service.SendMsg)
```

测试： [websocket在线测试 (websocket-test.com)](http://www.websocket-test.com/) 

![1673539945014](/1673539945014.png)



### 8、设计关系表，群信息表，消息表

```go
//群信息表
package models

import "gorm.io/gorm"

//群信息
type GroupBasic struct {
	gorm.Model
	Name    string
	OwnerId uint
	Icon    string
	Type    int
	Desc    string
}

func (table *GroupBasic) TableName() string {
	return "group_basic"
}


//人员关系表
package models

import "gorm.io/gorm"

//人员关系
type Contact struct {
	gorm.Model
	OwnerId  uint //谁得关系信息
	TargetId uint //对应的谁
	Type     int  //对应的类型 0 1 3
	Desc     string
}

func (table *Contact) TableName() string {
	return "contact"
}


//消息表
package models

import "gorm.io/gorm"

//消息
type Message struct {
	gorm.Model
	FromId   uint   //发送者
	TargetId uint   //接收者
	Type     string //消息类型  群聊 私聊 广播
	Media    int    //消息类型  文字，图片 ，音频
	Context  string //消息内容
	Pic      string
	Url      string
	Desc     string
	Amount   int //其他数字统计
}

func (table *Message) TableName() string {
	return "message"
}
```





### 9、发送消息 接收消息

​	需要：发送者ID，接受者ID，消息类型，消息类型，发送的内容

​		校验token，关系

```go
package models

import (
	"encoding/json"
	"fmt"
	"net"
	"net/http"
	"strconv"
	"sync"

	"github.com/gorilla/websocket"
	"gopkg.in/fatih/set.v0"
	"gorm.io/gorm"
)

// 消息
type Message struct {
	gorm.Model
	FromId   uint   //发送者
	TargetId uint   //接收者
	Type     int    //发送类型  群聊 私聊 广播
	Media    int    //消息类型  文字，图片 ，音频
	Context  string //消息内容
	Pic      string
	Url      string
	Desc     string
	Amount   int //其他数字统计
}

func (table *Message) TableName() string {
	return "message"
}

type Node struct {
	Conn      *websocket.Conn
	DataQueue chan []byte
	GroupSets set.Interface
}

// 映射关系
var clientMap map[int64]*Node = make(map[int64]*Node, 0)

// 读写锁
var rwLocker sync.RWMutex

func Chat(writer http.ResponseWriter, request *http.Request) {
	//1、获取参数并检验token   合法性
	query := request.URL.Query()
	Id := query.Get("userid")
	userId, _ := strconv.ParseInt(Id, 10, 64)
	//token:=query.Get("token")
	//targetId := query.Get("targetId")
	//context := query.Get("context")
	//msgtype := query.Get("type")
	isvalida := true //checkToke()  待......
	conn, err := (&websocket.Upgrader{
		//token权限校验
		CheckOrigin: func(r *http.Request) bool {
			return isvalida
		},
	}).Upgrade(writer, request, nil)
	if err != nil {
		fmt.Println(err)
		return
	}
	//2、获取链接
	node := &Node{
		Conn:      conn,
		DataQueue: make(chan []byte, 50),
		GroupSets: set.New(set.ThreadSafe),
	}
	//3、用户关系

	//4、userid和node绑定 并加锁
	rwLocker.Lock()
	clientMap[userId] = node
	rwLocker.Unlock()
	//5、完成发送逻辑
	go sendProc(node)
	//6、完成接收逻辑
	go resvProc(node)
	sendMsg(uint(userId), []byte("欢迎进入聊天室"))
}

func sendProc(node *Node) {
	for {
		select {
		case data := <-node.DataQueue:
			err := node.Conn.WriteMessage(websocket.TextMessage, data)
			if err != nil {
				fmt.Println(err)
				return
			}
		}
	}
}

func resvProc(node *Node) {
	for {
		_, data, err := node.Conn.ReadMessage()
		if err != nil {
			fmt.Println(err)
			return
		}
		broadMsg(data)
		fmt.Println("[ws]<<<<<<<<", data)
	}
}

var udpsendChan chan []byte = make(chan []byte, 1024)

func broadMsg(data []byte) {
	udpsendChan <- data
}
func init() {
	go udpSendProc()
	go udpRecvProc()
}

// 完成udp数据发送携程
func udpSendProc() {
	con, err := net.DialUDP("udp", nil, &net.UDPAddr{
		IP:   net.IPv4(192, 168, 0, 255),
		Port: 3000,
	})
	if err != nil {
		fmt.Println(err)
		return
	}
	defer con.Close()
	for {
		select {
		case data := <-udpsendChan:
			_, err := con.Write(data)
			if err != nil {
				fmt.Println(err)
				return
			}
		}
	}
}

// 完成udp数据接收携程
func udpRecvProc() {
	con, err := net.ListenUDP("ud", &net.UDPAddr{
		IP:   net.IPv4zero,
		Port: 3000,
	})
	if err != nil {
		fmt.Println(err)
		return
	}
	defer con.Close()
	for {
		var buf [512]byte
		n, err := con.Read(buf[0:])
		if err != nil {
			fmt.Println(err)
			return
		}
		dispatch(buf[0:n])
	}
}

// 后端调度逻辑
func dispatch(data []byte) {
	msg := Message{}
	err := json.Unmarshal(data, &msg)
	if err != nil {
		fmt.Println(err)
		return
	}
	switch msg.Type {
	case 1: //发送私信
		sendMsg(msg.TargetId, data)
		/* case 2:
			sendGroupMsg()
		case 3:
			sendAllMsg()
		case 4: */

	}
}

func sendMsg(userId uint, msg []byte) {
	rwLocker.RLock()
	node, ok := clientMap[int64(userId)]
	rwLocker.RUnlock()
	if ok {
		node.DataQueue <- msg
	}
}
```



### 10、集成html登录和注册

```go
//router里的app.go
r.GET("/", service.GetIndex)
r.GET("/index", service.GetIndex)
r.GET("/toRegister", service.ToRegister)

//index.go
package service

import (
	"fmt"
	"html/template"

	"github.com/gin-gonic/gin"
)

// GetIndex
// @Tags 首页
// @Success 200 {string} welcome
// @Router /index [get]
func GetIndex(c *gin.Context) {
	ind, err := template.ParseFiles("index.html", "views/chat/head.html")
	if err != nil {
		panic(err)
	}
	ind.Execute(c.Writer, "index")
	/* c.JSON(200, gin.H{
		"message": "welcome",
	}) */
}

func ToRegister(c *gin.Context) {
	ind, err := template.ParseFiles("views/user/register.html")
	fmt.Println("进入到register页面", ind)
	if err != nil {
		panic(err)
	}
	ind.Execute(c.Writer, "register")
	/* c.JSON(200, gin.H{
		"message": "welcome",
	}) */
}
```

然后引入：

```go
{{define "/chat/head.shtml"}}
<script>
    function userId(id) {
        if (typeof id == "undefined") {
            var r = sessionStorage.getItem("userid");
            if (!r) {
                return 0;
            } else {
                return parseInt(r)
            }
        } else {
            sessionStorage.setItem("userid", id);
        }
    }

    function userInfo(o) {
        if (typeof o == "undefined") {
            var r = sessionStorage.getItem("userinfo");
            if (!!r) {
                return JSON.parse(r);
            } else {
                return null
            }
        } else {
            sessionStorage.setItem("userinfo", JSON.stringify(o));
        }
    }
    var url = location.href;
    var isOpen = url.indexOf("/login") > -1 || url.indexOf("/register") > -1
    if (!userId() && !isOpen) {
        // location.href = "login.shtml";
    }
</script>
<!--登录所需-->
<link rel="stylesheet" href="/asset/css/login.css">
<!--聊天所需-->
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>IM解决方案</title>
<meta name="Description" content="专业的物联网行业方案专家，为广大新技术新产品新商业模式提供有力的解决方案支持">
<meta name="Keywords" content="无人售货机，小程序，推送，群聊,单聊app">
<link rel="stylesheet" href="/asset/plugins/mui/css/mui.css" />
<link rel="stylesheet" href="/asset/css/chat.css" />
<link rel="stylesheet" href="/asset/css/audio.css" />
<script src="/asset/plugins/mui/js/mui.js"></script>
<script src="/asset/js/vue.min.js"></script>
<script src="/asset/js/util.js"></script>
<script>
    function post(uri, data, fn) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "//" + location.host + "/" + uri, true);
        // 添加http头，发送信息至服务器时内容编码类型
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) {
                fn.call(this, JSON.parse(xhr.responseText));
            }
        };
        var _data = [];
        if (!!userId()) {
            // data["userid"] = userId();
        }
        for (var i in data) {
            _data.push(i + "=" + encodeURI(data[i]));
        }
        xhr.send(_data.join("&"));
    }

    function uploadfile(uri, dom, fn) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "//" + location.host + "/" + uri, true);
        // 添加http头，发送信息至服务器时内容编码类型
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) {
                fn.call(this, JSON.parse(xhr.responseText));
            }
        };
        var _data = [];
        var formdata = new FormData();
        if (!!userId()) {
            formdata.append("userid", userId());
        }
        formdata.append("file", dom.files[0])
        xhr.send(formdata);
    }

    function uploadblob(uri, blob, filetype, fn) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "//" + location.host + "/" + uri, true);
        // 添加http头，发送信息至服务器时内容编码类型
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) {
                fn.call(this, JSON.parse(xhr.responseText));
            }
        };
        var _data = [];
        var formdata = new FormData();
        formdata.append("filetype", filetype);
        if (!!userId()) {
            formdata.append("userid", userId());
        }
        formdata.append("file", blob)
        xhr.send(formdata);
    }

    function uploadaudio(uri, blob, fn) {
        uploadblob(uri, blob, ".mp3", fn)
    }

    function uploadvideo(uri, blob, fn) {
        uploadblob(uri, blob, ".mp4", fn)
    }
</script>

<style>
    .flex-container {
        display: flex;
        flex-direction: row;
        width: 100%;
        padding-top: 10px;
        position: fixed;
        bottom: 0px;
        background-color: #FFFFFF;
    }
    
    .item-1 {
        height: 50px;
        height: 50px;
        padding: 5px 5px 5px 5px;
    }
    
    .item-2 {
        margin-right: auto;
        height: 50px;
        width: 100%;
    }
    
    .txt {
        margin-right: auto;
    }
    
    .item-3 {
        height: 50px;
        height: 50px;
        padding: 5px 5px 5px 5px;
    }
    
    .item-4 {
        height: 50px;
        height: 50px;
        padding: 5px 5px 5px 5px;
    }
    
    li.chat {
        justify-content: flex-start;
        align-items: flex-start;
        display: flex;
    }
    
    .chat.other {
        flex-direction: row;
    }
    
    .chat.mine {
        flex-direction: row-reverse;
    }
    
    img.avatar {
        width: 64px;
        height: 64px;
    }
    
    .other .avatar {
        margin-left: 10px;
    }
    
    .mine .avatar {
        margin-right: 10px;
    }
    
    .other span {
        border: 10px solid;
        border-color: transparent #FFFFFF transparent transparent;
        margin-top: 10px;
    }
    
    .mine span {
        border: 10px solid;
        border-color: transparent transparent transparent #32CD32;
        margin-top: 10px;
    }
    
    .other>.content {
        background-color: #FFFFFF;
    }
    
    .mine>.content {
        background-color: #32CD32;
    }
    
    div.content {
        min-width: 60px;
        clear: both;
        display: inline-block;
        padding: 16px 16px 16px 10px;
        margin: 0 0 20px 0;
        font: 16px/20px 'Noto Sans', sans-serif;
        border-radius: 10px;
        min-height: 64px;
    }
    
    .content>img.pic {
        width: 100%;
        margin: 3px 3px 3px 3px;
    }
    
    .content>img.audio {
        width: 32px;
        color: white;
    }
    
    #panels {
        background-color: #FFFFFF;
        display: flex;
        position: fixed;
        bottom: 50px;
    }
    
    .doutures {
        flex-direction: row;
        flex-wrap: wrap;
        display: flex;
    }
    
    .doutures img {
        margin: 10px 10px 10px 10px;
    }
    
    .doutupkg {
        flex-direction: row;
        flex-wrap: wrap;
        display: flex;
    }
    
    .plugins {
        flex-direction: row;
        flex-wrap: wrap;
        display: flex;
    }
    
    .plugin {
        padding: 10px 10px 10px 20px;
        margin-left: 10px;
        margin-right: 10px;
    }
    
    .plugin img {
        width: 40px;
    }
    
    .plugin p {
        text-align: center;
        font-size: 16px;
    }
    
    .doutupkg img {
        width: 32px;
        height: 32px;
        margin: 5px 5px 5px 5px;
    }
    
    .upload {
        width: 64px;
        height: 64px;
        position: absolute;
        top: 1px;
        opacity: 0;
    }
    
    .tagicon {
        width: 32px;
        height: 32px;
    }
    
    .small {
        width: 32px;
        height: 32px;
    }
    
    .middle {
        width: 64px;
        height: 64px;
    }
    
    .large {
        width: 96px;
        height: 96px;
    }
    
    .res image {
        width: 32px;
        height: 32px;
    }
</style>
{{end}}
```



### 11、集成聊天页面 完成发送接收消息

```
前端需要拼接   Message对象
```

​	 需要 ：发送者ID ，接受者ID ，消息类型1，发送类型 1,发送的内容context token 

jsonStr = JSON.stringify(msg) 

websocket.send(jsonStr ) 

recvProc协程 读取数据 

发送给对应的人 

websocket.onMessage 

```
//app.go 加入router
r.GET("/toChat", service.ToChat)

//index.go加入
func ToChat(c *gin.Context) {
	ind, err := template.ParseFiles("views/chat/index.html",
		"views/chat/head.html",
		"views/chat/foot.html",
		"views/chat/tabmenu.html",
		"views/chat/concat.html",
		"views/chat/group.html",
		"views/chat/profile.html",
		"views/chat/main.html")
	if err != nil {
		panic(err)
	}
	userId, _ := strconv.Atoi(c.Query("userId"))
	token := c.Query("token")
	user := models.UserBasic{}
	user.ID = uint(userId)
	user.Identity = token
	fmt.Println("ToChat>>>>>>>>", user)
	ind.Execute(c.Writer, user)
}

//index.html
<!DOCTYPE html>
<html lang="en">

<head>
    <!--js include-->
    {{template "/chat/head.shtml"}}
</head>

<body>
    <header class="mui-bar mui-bar-nav">
        <h1 class="mui-title">登录</h1>
    </header>
    {{.}}
    <div class="mui-content" id="pageapp">
        <form id="login-form" class="mui-input-group">
            <div class="mui-input-row">
                <label>账号</label>
                <input v-model="user.name" placeholder="请输入用户名" type="text" class="mui-input-clear">
            </div>
            <div class="mui-input-row">
                <label>密码</label>
                <input v-model="user.password" placeholder="请输入密码" type="password" class="mui-input-password">
            </div>
        </form>
        <div class="mui-content-padded">
            <button @click="login" type="button" class="mui-btn mui-btn-block mui-btn-primary">登录</button>
            <div class="link-area"><a id='reg' href="/toRegister">注册账号</a> <span class="spliter">|</span> <a id='forgetPassword' href="register">忘记密码</a></div>
        </div>
        <div class="mui-content-padded oauth-area"></div>
    </div>
</body>

</html>
<script>
    var app = new Vue({
        el: "#pageapp",
        data: function() {
            return {
                user: {
                    name: "",
                    password: "",
                }
            }
        },
        methods: {
            login: function() {
                //检测手机号是否正确
                console.log("login")
                    //检测密码是否为空

                //网络请求
                //封装了promis
                util.post("/user/findUserByNameAndPwd", this.user).then(res => {
                    console.log(res)
                    if (res.code != 0) {
                        mui.toast(res.message)
                    } else {
                        location.href = "/toChat?userId=" + res.data.ID + "&token=" + res.data.Identity
                        mui.toast("登陆成功，即将跳转")
                    }
                })
            },
        }
    })
</script>

//views/chat/index.html
<!DOCTYPE html>
<html>

<head>
    <!--js include-->
    {{template "/chat/head.shtml"}}
</head>

<body>
    <!--底部菜单-->
    {{template "/chat/tabmenu.shtml"}}
    <header class="mui-bar mui-bar-nav">
    </header>
    <div class="mui-content" id="pageapp">
        <!--联系人-->
        {{template "/chat/concat.shtml"}}
        <!--群聊-->
        {{template "/chat/group.shtml"}}
        <!--个人中心-->
        {{template "/chat/profile.shtml"}}
        <!--聊天主界面-->
        {{template "/chat/main.shtml"}}

    </div>
</body>

</html>
{{template "/chat/foot.shtml"}}
```



### 12、调试前端页面

关键让后端的loadFriend在前端显示

```go
{{define "/chat/foot.shtml"}}
<script>
    function upload(dom) {
        uploadfile("attach/upload", dom, function(res) {
            if (res.code == 0) {
                app.sendpicmsg(res.data)
            }

        })
    }

    function userId() {
        return parseInt(util.parseQuery("userId"))
    }
    var app = new Vue({
        el: "#pageapp",
        data: {
            usermap: {},
            friends: [],
            communitys: [],
            profile: {
                avatar: "",
                nickname: "",
                memo: "",
            },
            webSocket: {},
            win: "main",
            txtmsg: "",
            panelstat: "kbord",
            txtstat: "kbord",
            title: "",
            doutu: {
                config: {
                    "baseurl": "/asset/plugins/doutu/",
                    "pkgids": ["mkgif", "emoj"]
                },
                packages: [],
                choosed: {
                    "pkgid": "emoj",
                    "assets": [],
                    "size": "small"
                }
            },
            msglist: [],

            msgcontext: {
                dstid: 10,
                cmd: 10,
                userId: userId()
            },
            plugins: [{
                    icon: "/asset/images/upload.png",
                    name: "照片",
                    id: "upload",
                    slot: "<input accept=\"image/gif,image/jpeg,,image/png\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                },

                {
                    icon: "/asset/images/camera.png",
                    name: "拍照",
                    id: "camera",
                    slot: "<input accept=\"image/*\" capture=\"camera\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                }, {
                    icon: "/asset/images/audiocall.png",
                    name: "语音",
                    id: "audiocall"
                }, {
                    icon: "/asset/images/videocall.png",
                    name: "视频",
                    id: "videocall"
                }, {
                    icon: "/asset/images/redpackage.png",
                    name: "红包",
                    id: "redpackage"
                }, {
                    icon: "/asset/images/exchange.png",
                    name: "转账",
                    id: "exchange"
                }, {
                    icon: "/asset/images/address.png",
                    name: "地址",
                    id: "address"
                }, {
                    icon: "/asset/images/person.png",
                    name: "名片",
                    id: "person"
                }

            ],
            timer: 0,
            recorder: {},
            allChunks: [],
            iscomplete: false,
            duration: 0,
            showprocess: false,
        },
        created: function() {
            this.loadfriends();
            this.loadcommunitys();
            this.loaddoutures();
            var user = userInfo()
            if (!!user) {
                this.profile.avatar = user.avatar;
                this.profile.nickname = user.nickname;
                this.profile.memo = user.memo;
            }

            this.initwebsocket()

        },
        mounted: function() {

        },
        methods: {
            playaudio: function(url) {
                document.getElementById('audio4play').src = url;
                document.getElementById('audio4play').play();
            },
            startrecorder: function() {
                let audioTarget = document.getElementById('audio');
                var types = ["video/webm",
                    "audio/webm",
                    "video/webm\;codecs=vp8",
                    "video/webm\;codecs=daala",
                    "video/webm\;codecs=h264",
                    "audio/webm\;codecs=opus",
                    "video/mpeg"
                ];
                var suporttype = "";
                for (var i in types) {
                    if (MediaRecorder.isTypeSupported(types[i])) {
                        suporttype = types[i];
                    }
                }
                if (!suporttype) {
                    mui.toast("编码不支持")
                    return;
                }

                this.duration = new Date().getTime();
                navigator.mediaDevices.getUserMedia({
                        audio: true,
                        video: false
                    })
                    .then(function(stream) {
                        this.showprocess = true
                        this.recorder = new MediaRecorder(stream);
                        audioTarget.srcObject = stream;

                        this.recorder.ondataavailable = (event) => {
                            console.log("ondataavailable");
                            uploadblob("attach/upload", event.data, ".mp3", res => {
                                var duration = Math.ceil((new Date().getTime() - this.duration) / 1000);
                                this.sendaudiomsg(res.data, duration);
                            })
                            stream.getTracks().forEach(function(track) {
                                track.stop();
                            });
                            this.showprocess = false
                        }
                        this.recorder.start();
                    }.bind(this)).
                catch(function(err) {
                    console.log(err)
                    mui.toast(err)
                    this.showprocess = false
                }.bind(this));
            },
            stoprecorder: function() {
                if (typeof this.recorder.stop == "function") {
                    this.recorder.stop();
                }
                this.showprocess = false
                console.log("stoprecorder")

            },
            dispatchplugin: function(item) {
                switch (item.id) {
                    case "upload":
                    case "camera":

                        break;
                    default:
                        mui.toast("系统暂不支持,请自行扩展")
                }
            },
            reset: function() {
                this.panelstat = "kbord";
                this.txtstat = "kbord";
                this.txtmsg = "";
            },
            createmsgcontext: function() {
                return JSON.parse(JSON.stringify(this.msgcontext))
            },
            loaddoutures: function() {
                var res = [];
                var config = this.doutu.config;
                for (var i in config.pkgids) {
                    res[config.pkgids[i]] = (config.baseurl + "/" + config.pkgids[i] + "/info.json")
                }
                var that = this;
                for (var id in res) {
                    //console.log("res[i]",id,res[id])
                    post(res[id], {}, function(pkginfo) {
                        //console.log("post res[i]",id,res[id],pkginfo)
                        var baseurl = config.baseurl + "/" + pkginfo.id + "/"
                        for (var j in pkginfo.assets) {
                            pkginfo.assets[j] = baseurl + pkginfo.assets[j];
                        }
                        pkginfo.icon = baseurl + pkginfo.icon;
                        that.doutu.packages.push(pkginfo)
                        if (that.doutu.choosed.pkgid == pkginfo.id) {
                            that.doutu.choosed.assets = pkginfo.assets;
                        }

                    })
                }
            },
            showweixin: function() {
                mui.alert("请加微信号jiepool-winlion索取")
            },
            showmsg: function(user, msg) {
                var data = {

                }
                data.ismine = userId() == msg.userId;
                //console.log(data.ismine,userId(),msg.userid)
                data.user = user;
                data.msg = msg;
                this.msglist = this.msglist.concat(data)
                this.reset();
                var that = this;
                that.timer = setTimeout(function() {
                    window.scrollTo(0, document.getElementById("convo").offsetHeight);
                    clearTimeout(that.timer)
                }, 100)

            },
            startrecord: function() {

            },
            sendtxtmsg: function(txt) {
                //{id:1,userid:2,dstid:3,cmd:10,media:1,content:"hello"}
                var msg = this.createmsgcontext();
                msg.media = 1;
                msg.content = txt;
                this.showmsg(userInfo(), msg);
                this.webSocket.send(JSON.stringify(msg))
            },
            sendpicmsg: function(picurl) {
                //{id:1,userid:2,dstid:3,cmd:10,media:4,url:"http://www.baidu.com/a/log,jpg"}
                var msg = this.createmsgcontext();
                msg.media = 4;
                msg.url = picurl;
                this.showmsg(userInfo(), msg)
                this.webSocket.send(JSON.stringify(msg))
            },
            sendaudiomsg: function(url, num) {
                //{id:1,userid:2,dstid:3,cmd:10,media:3,url:"http://www.a,com/dsturl.mp3",anount:40}
                var msg = this.createmsgcontext();
                msg.media = 3;
                msg.url = url;
                msg.amount = num;
                this.showmsg(userInfo(), msg)
                    //console.log("sendaudiomsg",this.msglist);
                this.webSocket.send(JSON.stringify(msg))
            },
            singlemsg: function(user) {
                //console.log(user)
                this.win = "single";
                this.title = "和" + user.Name + "聊天中";
                this.msgcontext.dstid = parseInt(user.ID);
                this.msgcontext.cmd = 1;
            },
            groupmsg: function(group) {

                this.win = "group";
                this.title = group.name;
                this.msgcontext.dstid = parseInt(group.id);
                this.msgcontext.cmd = 11;
            },
            loaduserinfo: function(userId, cb) {
                userId = "" + userId;
                var userinfo = this.usermap[userId];
                if (!userinfo) {
                    post("user/find", {
                        id: parseInt(userId)
                    }, function(res) {
                        cb(res.data);
                        this.usermap[userId] = res.data;
                    }.bind(this))
                } else {
                    cb(userinfo)
                }
            },
            onmessage: function(data) {

                this.loaduserinfo(data.userId, function(user) {
                    this.showmsg(user, data)
                }.bind(this))

            },
            initwebsocket: function() {
                var url = "ws://" + location.host + "/user/sendUserMsg?id=" + userId() + "&token=" + util.parseQuery("token");
                this.webSocket = new WebSocket(url);
                //消息处理
                this.webSocket.onmessage = function(evt) {
                        //{"data":"}",...}
                        if (evt.data.indexOf("}") > -1) {
                            this.onmessage(JSON.parse(evt.data));
                        } else {
                            console.log("recv<==" + evt.data)
                        }
                    }.bind(this)
                    //关闭回调
                this.webSocket.onclose = function(evt) {
                        console.log(evt.data)
                    }
                    //出错回调
                this.webSocket.onerror = function(evt) {
                        console.log(evt.data)
                    }
                    /*{
                        this.webSocket.send()
                    }*/
            },
            sendmsg: function() {

            },
            loadfriends: function() {
                var that = this;
                post("searchFriends", {
                    userId: userId()
                }, function(res) {
                    that.friends = res.Rows || [];
                    var usermap = this.usermap;
                    for (var i in res.Rows) {
                        var k = "" + res.Rows[i].ID
                        usermap[k] = res.Rows[i];
                    }
                    this.usermap = usermap;
                }.bind(this))
            },
            loadcommunitys: function() {
                var that = this;
                post("contact/loadcommunity", {
                    userId: userId()
                }, function(res) {
                    that.communitys = res.rows || [];
                })
            },
            addfriend: function() {
                var that = this;
                //prompt
                mui.prompt('', '请输入好友ID', '加好友', ['取消', '确认'], function(e) {
                    if (e.index == 1) {
                        if (isNaN(e.value) || e.value <= 0) {
                            mui.toast('格式错误');
                        } else {
                            //mui.toast(e.value);
                            that._addfriend(e.value)
                        }
                    } else {
                        //mui.toast('您取消了入库');
                    }
                }, 'div');
                document.querySelector('.mui-popup-input input').type = 'number';
            },
            _addfriend: function(dstobj) {
                var that = this
                post("contact/addfriend", {
                    dstid: dstobj,
                    userId: userId()
                }, function(res) {
                    if (res.code == 0) {
                        mui.toast("添加成功");
                        that.loadfriends();
                    } else {
                        mui.toast(res.msg);
                    }
                })
            },
            _joincomunity: function(dstobj) {
                var that = this;
                post("contact/joincommunity", {
                    dstid: dstobj,
                    "userId": userId()
                }, function(res) {
                    if (res.code == 0) {
                        mui.toast("添加成功");

                        that.loadcommunitys();
                    } else {
                        mui.toast(res.msg);
                    }
                })
            },
            joincomunity: function() {
                var that = this;
                mui.prompt('', '请输入群号', '加群', ['取消', '确认'], function(e) {
                    if (e.index == 1) {
                        if (isNaN(e.value) || e.value <= 0) {
                            mui.toast('格式错误');
                        } else {
                            //mui.toast(e.value);
                            that._joincomunity(e.value)
                        }
                    } else {
                        //mui.toast('您取消了入库');
                    }
                }, 'div');
                document.querySelector('.mui-popup-input input').type = 'number';
            },
            quit: function() {
                sessionStorage.removeItem("userid")
                sessionStorage.removeItem("userinfo")
                location.href = "login.shtml"
            }


        },
        watch: {
            "win": function(n, o) {
                // console.log("watch",o,n)
                if (n != "main") {
                    document.getElementById("menubar").style.display = "none";
                } else {
                    document.getElementById("menubar").style.display = "block";
                }
            }
        }
    })
</script>
{{end}}

//请求的返回
func SearchFriends(c *gin.Context) {
	id, _ := strconv.Atoi(c.Request.FormValue("userId"))
	users := models.SearchFriends(uint(id))
	/* c.JSON(200, gin.H{
		"code":    0,
		"message": "查询好友列表成功",
		"data":    users,
	}) */
	utils.RespOKList(c.Writer, users, len(users))
}
```

调试前后端，首先通过页面和postman测试，再调试前端页面，然后再post到后端，确保发送正常之后再调试前端显示。



开启Debug模式

在launch文件中写入以下内容

```json
{
    // 使用 IntelliSense 了解相关属性。 
    // 悬停以查看现有属性的描述。
    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name":"golang",
            "type":"go",
            "request":"launch",
            "mode":"auto",
            //当运行单个文件时{workspaceFolder}可以改为{file}
            "program":"${workspaceFolder}",
            "env":{},
            "args":[]
        }
    ]
}
```

